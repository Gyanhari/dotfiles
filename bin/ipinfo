#!/usr/bin/env bash

# Usage: ipinfo <IP_ADDRESS>
# Example: ipinfo 8.8.8.8

if [ -z "$1" ]; then
    echo "Usage: ipinfo <IP_ADDRESS>"
    echo "Example: ipinfo 8.8.8.8"
    exit 1
fi

IP="$1"

# Validate IP format (basic regex)
if ! [[ $IP =~ ^[0-9]{1,3}(\.[0-9]{1,3}){3}$ ]]; then
    echo "Invalid IP address format."
    exit 1
fi

for octet in $(echo "$IP" | tr '.' ' '); do
    if [ "$octet" -lt 0 ] || [ "$octet" -gt 255 ]; then
        echo "Invalid IP address: octet $octet out of range."
        exit 1
    fi
done

echo "Looking up $IP..."
RESPONSE=$(curl -s "https://ipinfo.io/$IP?token=286fad86482cad")


# Check if response is valid JSON and not an error
if echo "$RESPONSE" | grep -q "rate limit\|error\|wrong"; then
    echo "Error: $(echo "$RESPONSE" | jq -r '.error // .message // "Unknown error"')"
    exit 1
fi

if command -v jq >/dev/null 2>&1; then
    echo "$RESPONSE" | jq .
else
    echo "$RESPONSE"
fi
